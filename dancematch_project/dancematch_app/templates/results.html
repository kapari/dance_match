{% extends "base_generic.html" %}
{% load staticfiles %}

{% block content %}

<script>
    var user_id = {{ user.id }}

    // TODO write filter
    function filterPrefs(data, user_id) {

    }

    function sortByDance(a, b) {
        if (a.dance > b.dance) {
            return 1;
        } else if (a.dance < b.dance) {
            return -1;
        } else {
            return 0;
        }
    }

    function drawPrefs(data, user_id) {
        var pl = document.getElementById("pref_list");
        var template = pl.getElementsByClassName("template")[0];

        data.sort(sortByDance);

        for (var i = 0; i < data.length; i++) {
            var current_pref = data[i];

            if (current_pref.user_id != user_id) {
                console.log("user_id " + user_id);
                var clone = template.cloneNode(true);
                clone.classList.remove("template");
//                clone.classList.add("hide");

                clone.setAttribute("data-id", current_pref.id);

                clone.getElementsByClassName("thumb")[0].setAttribute('src', current_pref.img_path);
                clone.getElementsByClassName("dancer")[0].innerHTML = current_pref.first_name;
                clone.getElementsByClassName("dance")[0].innerHTML = current_pref.dance;
                clone.getElementsByClassName("dance")[0].setAttribute('data-id', current_pref.dance_id);
                clone.getElementsByClassName("role")[0].innerHTML = current_pref.role;
                clone.getElementsByClassName("skill_level")[0].innerHTML = current_pref.skill_level;
                clone.getElementsByClassName("goal")[0].innerHTML = current_pref.goal;
                clone.getElementsByClassName("notes")[0].innerHTML = current_pref.notes;

                // TODO show only suburbs that match current user's prefs
                var location_cell = clone.getElementsByClassName("suburbs")[0];
                var suburb_list = current_pref.suburbs;

                if (suburb_list.length > 0) {
                    for (var j = 0; j < suburb_list.length; j++) {
                        console.log(suburb_list[j].sub_name);
                        var name_span = document.createElement("span");
                        name_span.innerHTML += suburb_list[j].sub_name;
                        location_cell.appendChild(name_span);
                    }
                } else {
                    location_cell.innerHTML += '';
                }


                pl.appendChild(clone);
            }
        }
    }

    // BEGIN WEB REST API CALL TO GET JSON DATA
    function ApiCall(url, function_name) {
        var request = new XMLHttpRequest();
        request.open("GET", url);

        //For pre html5 browsers use onstatuschanged
        request.onloadend = function (e) {
            var json_string = e.currentTarget.responseText;
            var data = JSON.parse(json_string);
            function_name(data, user_id);
        };
        request.send();
    }

    ApiCall("/api_dance_prefs/", drawPrefs);

</script>

<table>
    <caption>
            A listing of all dances uploaded by site users.
    </caption>
    <thead>
        <tr>
            <th id="profile_img">Image</th>
            <th id="name">Name</th>
            <th id="dance">Dance</th>
            <th id="role">Role</th>
            <th id="skill_level">Level</th>
            <th id="goal">Goal</th>
            <th id="notes">Description</th>
            <th id="location">Location Match</th>
        </tr>
    </thead>
    <tbody id="pref_list">
        <tr class="template">
            <td headers="profile_img" class="profile_img">
                <img src="" class="thumb">
            </td>
            <td headers="dancer" class="dancer">Dancer</td>
            <td headers="dance" class="dance">Dance Style</td>
            <td headers="role" class="role">Role</td>
            <td headers="skill_level" class="skill_level">Skill Level</td>
            <td headers="goal" class="goal">Goal</td>
            <td headers="notes" class="notes">Notes here.</td>
            <td headers="location" class="suburbs"></td>
        </tr>
    </tbody>
</table>

{% endblock %}
