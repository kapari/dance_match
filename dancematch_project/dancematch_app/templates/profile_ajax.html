{% extends "base_generic.html" %}
{% load staticfiles %}

{% block content %}

<script>
    document.write("test");
    // Draw Loaded Data

    // TODO: get from new app status view
    var user_id = 2;
    var models = {};

    function select_options(select, data, name_field, id_field, selected) {
        var not_set = true;
        for (var i = 0; i < data.length; i++) {
            var option = document.createElement('option');
            option.innerHTML = data[i][name_field];
            option.setAttribute("value", data[i][id_field]);
            if (data[i][name_field] == selected) {
                option.setAttribute("selected", "selected");
                not_set = false;
            }
            select.appendChild(option);
        }
        if (not_set) {
            option.innerHTML = "(optional)";
            option.setAttribute("selected", "selected");
        }
    }

    function draw(data, dancer_id) {
        var pl = document.getElementById("pref_list");
        var template = pl.getElementsByClassName("template")[0];

        for (var i = 0; i < data.length; i++) {
            var current_pref = data[i];
            if (!dancer_id || current_pref.dancer_id == dancer_id) {
                var clone = template.cloneNode(true);
                clone.classList.remove("template");
                clone.setAttribute("data-id", current_pref.id);
                clone.getElementsByClassName("dancer")[0].innerHTML = current_pref.dancer;
                clone.getElementsByClassName("dance")[0].innerHTML = current_pref.dance;
                clone.getElementsByClassName("role")[0].innerHTML = current_pref.role;

                if (current_pref.skill_level) {
                    clone.getElementsByClassName("skill_level")[0].innerHTML = current_pref.skill_level;
                } else {
                    clone.getElementsByClassName("skill_level")[0].innerHTML = "";
                }

                if (current_pref.activity) {
                    clone.getElementsByClassName("activity")[0].innerHTML = current_pref.activity;
                } else {
                    clone.getElementsByClassName("activity")[0].innerHTML = "";
                }

                if (current_pref.goal) {
                    clone.getElementsByClassName("goal")[0].innerHTML = current_pref.goal;
                } else {
                    clone.getElementsByClassName("goal")[0].innerHTML = "";
                }
                clone.getElementsByClassName("notes")[0].innerHTML = current_pref.notes;

                var selected_dance = current_pref.dance;
                select_options(clone.getElementsByClassName("dance_list")[0],
                        window.models["dances"], "name", "id", selected_dance);

                var selected_role = current_pref.role;
                select_options(clone.getElementsByClassName("role_list")[0],
                        window.models["roles"], "name", "id", selected_role);

                var selected_skill_level = current_pref.skill_level;
                select_options(clone.getElementsByClassName("skill_level_list")[0],
                            window.models["skill_levels"], "name", "id", selected_skill_level);

                var selected_activity = current_pref.activity;
                select_options(clone.getElementsByClassName("activity_list")[0],
                            window.models["activity"], "name", "id", selected_activity);

                var selected_goal = current_pref.goal;
                select_options(clone.getElementsByClassName("goal_list")[0],
                            window.models["goals"], "name", "id", selected_goal);

                clone.getElementsByClassName("notes_textarea")[0].innerHTML = current_pref.notes;

                pl.appendChild(clone);
            }

        }
//        document.body.innerHTML = data
    }


    function add_listeners() {

        var edit_divs = document.getElementsByClassName("edit");

        for (i = 0; i < edit_divs.length; i++) {
            current_div = edit_divs[i];
//            console.log(current_div);
            edit_fields = current_div.children;
//            console.log(edit_fields);
            for (i = 0; i < edit_fields.length; i++) {
                field = edit_fields[i];
                console.log(field);
                field.addEventListener("change", function (e) {
                    console.log(this);
                    console.log(e.target);
                });
            }
        }

//        var selects = document.getElementsByTagName("select");
//        var textareas = document.getElementsByTagName("textarea");
//        var editable_fields = selects.concat(textareas);
//
//        for (i = 0; i < editable_fields.length; i++) {
//            var field = editable_fields[i];
//            console.log(field);
//            field.addEventListener("change", function(e) {
//                console.log(this);
//                console.log(e.target);
//            });
//        }
    }

    function model_api(object_type) {
        // get list of e.g. dances for dropdown
        var url = "/api_" + object_type + "/";
        var request = new XMLHttpRequest();
        request.open("GET", url);
        console.log(request);

        //For pre html5 browsers use onstatuschanged
        request.onloadend = function (e) {
            var json_string = e.currentTarget.responseText;
            var data = JSON.parse(json_string);
            window.models[object_type] = data;
        };

        request.send();
    }

    model_api("dances");
    model_api("roles");
    model_api("skill_levels");
    model_api("activity");
    model_api("goals");


    // BEGIN WEB REST API CALL TO GET JSON DATA
    var url = "/api_dance_prefs/";
    var request = new XMLHttpRequest();
    request.open("GET", url);

    //For pre html5 browsers use onstatuschanged
    request.onloadend = function (e) {
        var json_string = e.currentTarget.responseText;
        var data = JSON.parse(json_string);
        draw(data, user_id);
        add_listeners();
    };

    request.send();




    // get list of e.g. dances for dropdown
//    var url = "/api_dances/";
//    var request = new XMLHttpRequest();
//    request.open("GET", url);
//
//    //For pre html5 browsers use onstatuschanged
//    request.onloadend = function (e) {
//        var json_string = e.currentTarget.responseText;
//        var data = JSON.parse(json_string);
//        window.dances = data;
//    };
//
//    request.send();

</script>


<h1>{{ dancer.name }}</h1>

{% if dancer.active_member %}
    {{ dancer.name }} is looking for a buddy!
{% else %}
    {{ dancer.name }} is not currently looking for a buddy.
{% endif %}

<div class="bio">
    {{ dancer.bio }}
</div>
<div class="contact">
    {{ dancer.email }}
</div>

<br>
<a href="/edit/{{ dancer.id }}">Edit</a>

<h2>{{ dancer.name }}'s Dances</h2>

<a href="/edit/{{ dancer.id }}/0/">Add a new dance</a>

<div id="pref_list">
    <ul class="pref">
        <li class="selected template">
            <div class="read">
                <span class="dance">Dance Style</span>
                <span class="role">Role</span>
                <span class="skill_level">Skill Level</span>
                <span class="activity">Activity Level</span>
                <span class="goal">Goal</span>
                <span class="notes">Notes here.</span>
                <span class="dancer">Dancer name</span>
            </div>
            <div class="edit">
                <select class="dance_list">Dance Style</select>
                <select class="role_list">Role</select>
                <select class="skill_level_list">Skill Level</select>
                <select class="activity_list">Activity Level</select>
                <select class="goal_list">Goal</select>
                <textarea class="notes_textarea">Notes here.</textarea>
            </div>
        </li>
    </ul>
</div>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

{% endblock %}