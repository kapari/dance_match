{% extends "base_generic.html" %}
{% load staticfiles %}

{% block content %}


<script>
    // TODO pull js into separate files
    var user_id = {{ user.id }}
    var dancer_id = {{ user.dancer.id }}
    var models = {};

    // TODO: finish implementing namespace
    var DM = {
        model_list: ["dance", "role", "skill_level", "activity", "goal"],
        model_list_list: ["dance_list", "role_list", "skill_level_list", "activity_list", "goal_list"]
//        model: {
//            items: []
//        }
    };

    document.write("test for user ID: " + user_id + " -- dancer ID: " + dancer_id);
    // Draw Loaded Data


    function drawDropdown(select, data, name_field, id_field, selected) {
        for (var i = 0; i < data.length; i++) {
            var option = document.createElement('option');
            option.innerHTML = data[i][name_field];
            option.setAttribute("value", data[i][id_field]);
            if (data[i][name_field] == selected) {
                option.setAttribute("selected", "selected");
            }
            select.appendChild(option);
        }
    }


    function drawPrefRead(parent, current_pref) {
        var models = DM.model_list;
        for (i = 0; i < models.length; i++) {
            console.log(models[i]);
            parent.getElementsByClassName(models[i])[0].innerHTML = current_pref[models[i]];
        }
        parent.getElementsByClassName("notes")[0].innerHTML = current_pref.notes;
    }


    function drawPrefEdit(parent, current_pref) {
        var models = DM.model_list;
        var model_lists = DM.model_list_list;
        for (i = 0; i < models.length; i++) {
            drawDropdown(parent.getElementsByClassName(model_lists[i])[0],
                    window.models[model_lists[i]], "name", "id", current_pref[models[i]]);
        }
        parent.getElementsByClassName("notes_textarea")[0].innerHTML = current_pref.notes;
    }


    function drawProfile(data, user_id) {
        var profile = document.getElementById("profile");
        // only one dict in list
        var profile_data = data[0];
        console.log(data);
        console.log(profile_data);
        profile.getElementsByClassName("username")[0].innerText = profile_data["username"];
        profile.getElementsByClassName("first_name")[0].innerText = profile_data["first_name"];
        profile.getElementsByClassName("last_name")[0].innerText = profile_data["last_name"];
        profile.getElementsByClassName("bio")[0].innerText = profile_data["bio"];
        profile.getElementsByClassName("profile_img")[0].setAttribute('src', profile_data["profile_img"]);

        // fill & hide edit fields
        var edit_div = profile.getElementsByClassName("edit")[0];
        edit_div.classList.add("hide");
        profile.getElementsByClassName('edit_field')[0].value = profile_data["first_name"];
        profile.getElementsByClassName('edit_field')[1].value = profile_data["last_name"];
        profile.getElementsByClassName('edit_field')[2].value = profile_data["bio"];

        addProfileListeners();

        toggle_button = profile.getElementsByClassName("edit_toggle")[0];
        addToggleListener(toggle_button);
    }


    function drawPrefList(parent, template, data, user_id) {
        for (var i = 0; i < data.length; i++) {
            var current_pref = data[i];

            // Draw pref only if user id matches current user
            if (!user_id || current_pref.user_id == user_id) {
                console.log("user_id " + user_id);
                var clone = template.cloneNode(true);
                clone.classList.remove("template");
                clone.setAttribute("data-id", current_pref.id);

                // Read-only div
                drawPrefRead(clone, current_pref);

                // Edit div
                var edit_div = clone.getElementsByClassName("edit")[0];
                edit_div.classList.add("hide");
                drawPrefEdit(clone, current_pref);

                toggle_button = clone.getElementsByClassName("edit_toggle")[0];
                addToggleListener(toggle_button);

                parent.appendChild(clone);
            }
        }
    }


    function drawPrefItems(data, user_id) {
        var pl = document.getElementById("pref_list");
        var template = pl.getElementsByClassName("template")[0];

        drawPrefList(pl, template, data, user_id);
        addPrefListeners("pref_list");
    }


    function addProfileListeners() {
        var profile = document.getElementById("profile");
        var edit_fields = profile.getElementsByClassName('edit_field');
        var update = {"user_id": user_id};

        for (i = 0; i < edit_fields.length; i++) {
            current_field = edit_fields[i];
            current_field.addEventListener("change", function(e) {
                var value = e.target.value;
                var field_name = e.target.name;
                update[field_name] = value;
                profile.getElementsByClassName(field_name)[0].innerText = value;

                sendPost(update, "/update_profile/")
            });
        }
    }

    function onPrefUpdate(e) {

    }

    function addPrefListeners(parent_id) {
        var pref_list = document.getElementById(parent_id);
        var edit_fields = pref_list.getElementsByClassName("edit_field");
        for (i = 0; i < edit_fields.length; i++) {
            var current_field = edit_fields[i];
            console.log("current field = " + current_field);

            // TODO: pull out anonymous function; too long
            current_field.addEventListener("change", function (e) {
                var group_div = e.target.parentElement;
                var pref_id_div = group_div.parentElement;
                var pref_id = pref_id_div.getAttribute("data-id");

                var update = {"user_id": user_id,
                              "pref_id": pref_id};
                var value = e.target.value;
                var text = '';

                // Build update dict & Change values in read-only
                // TODO: loop

                if (e.target.classList.contains("dance_list")) {
                    update["dance"] = value;
                    text = updateReadOnly(value, "dance_list");
                    pref_id_div.getElementsByClassName("dance")[0].innerText = text;
                } else if (e.target.classList.contains("role_list")){
                    update["role"] = value;
                    text = updateReadOnly(value, "role_list");
                    pref_id_div.getElementsByClassName("role")[0].innerText = text;
                } else if (e.target.classList.contains("skill_level_list")){
                    update["skill_level"] = value;
                    text = updateReadOnly(value, "skill_level_list");
                    pref_id_div.getElementsByClassName("skill_level")[0].innerText = text;
                } else if (e.target.classList.contains("activity_list")){
                    update["activity"] = value;
                    text = updateReadOnly(value, "activity_list");
                    pref_id_div.getElementsByClassName("activity")[0].innerText = text;
                } else if (e.target.classList.contains("goal_list")){
                    update["goal"] = value;
                    text = updateReadOnly(value, "goal_list");
                    pref_id_div.getElementsByClassName("goal")[0].innerText = text;
                } else if (e.target.classList.contains("notes_textarea")){
                    update["notes"] = value;
                    pref_id_div.getElementsByClassName("notes")[0].innerText = value;
                }

                sendPost(update, "/update_pref/");
            });
        }
    }


    function updateReadOnly(value, model) {
        var option_list = window.models[model];
        var option_count = option_list.length;
        var text = "NOPE";
        for (i = 0; i < option_count; i++) {
            var option = option_list[i];
            if (option.id == value) {
                text = option.name;
                break;
            }
        }
        return text;
    }

    // Show/hide
    function addToggleListener(button) {
        button.addEventListener("click", function(e) {
            var pref_li = button.parentElement.parentElement;
            var edit_div = pref_li.getElementsByClassName("edit")[0];
            var read_div = pref_li.getElementsByClassName("read")[0];
            edit_div.classList.toggle("hide");
            read_div.classList.toggle("hide");
            button.classList.toggle("show_edit");
            if (button.classList.contains("show_edit")) {
                button.innerText = "Done";
            } else {
                button.innerText = "Edit";
            }
        });
    }

    // AJAX POST
    function sendPost(item, url) {
        var form_data = new FormData();

        for (var key in item) {
            form_data.append(key, item[key]);
        }

        var request = new XMLHttpRequest();
        request.open("POST", url);
        request.send(form_data);
    }

    // TODO: wrap all api calls together
    var api_counter = 0;
    var api_loaded = false;
    function modelApi(object_type) {
        // get list of e.g. dances for dropdown
        var url = "/api_" + object_type + "/";
        var request = new XMLHttpRequest();
        request.open("GET", url);
        console.log(request);

        //For pre html5 browsers use onstatuschanged
        request.onloadend = function (e) {
            var json_string = e.currentTarget.responseText;
            var data = JSON.parse(json_string);
            window.models[object_type] = data;
            api_counter++;
            console.log(object_type + ": " + api_counter);
            console.log(model_list.length);
            if (api_counter == model_list.length) {
                api_loaded = true;
            }
        };
        request.send();
    }

    var model_list = DM.model_list_list;
    for (i = 0; i < model_list.length; i++) {
        modelApi(model_list[i]);
    }


    // TODO: run on button click; break into smaller functions
    function newPref(user_id) {
        if (!api_loaded) {
            setTimeout(newPref, 100, user_id);
            console.log("waiting...");
            return
        }
        var parent = document.getElementById("new_pref");
        var template = document.getElementsByClassName("template")[0];
        var clone = template.cloneNode(true);

        var btn_div = parent.getElementsByClassName("btn_div")[0];
        clone.classList.remove("template");
        parent.insertBefore(clone, btn_div);

        var new_pref_id = 0;
        var new_pref = {"user_id": user_id,
                        "pref_id": new_pref_id,
                        "dance": 1,
                        "role": 1,
                        "skill_level": 1,
                        "activity": 1,
                        "goal": 1,
                        "notes": ''
                        };

        drawPrefRead(parent, new_pref);
        drawPrefEdit(parent, new_pref);

        var button = parent.getElementsByClassName("save_pref");
        button.addEventListener("click", function(e) {
            sendPost(new_pref, "/update_pref/")
        });
        var cancel_btn = document.getElementsByClassName("cancel_pref");
        cancel_btn.addEventListener("click", function(e) {
            div.classList.add("hide");
        });
    }

    // BEGIN WEB REST API CALL TO GET JSON DATA
    function ApiCall(url, function_name) {
        var request = new XMLHttpRequest();
        request.open("GET", url);

        //For pre html5 browsers use onstatuschanged
        request.onloadend = function (e) {
            var json_string = e.currentTarget.responseText;
            var data = JSON.parse(json_string);
            function_name(data, user_id);
        };
        request.send();
    }

    document.addEventListener("DOMContentLoaded", function(e) {
                ApiCall("/api_dance_prefs/", drawPrefItems);
                ApiCall("/api_profile/", drawProfile);
//                if (api_loaded) {
//                    newPref(user_id);
//                } else {
//                    setTimeout(function(){
//                        newPref(user_id)
//                    }, 5000);
//                }
//                while (!api_loaded) {
//                    console.log("waiting...");
//                }
                newPref(user_id);
        }
    );

    // TODO: Init: create namespace, gather data, draw things, add listeners

</script>


<h1>{{ dancer.name }}</h1>

<div id="profile">
    <div class="read">
        <img src="" class="profile_img">
        <span class="username">Username</span>
        <span class="first_name">First Name</span>
        <span class="last_name">Last Name</span>
        <span class="bio">Bio goes here</span>
    </div>
    <div class="edit">
        <p>
            <a href="/img_upload/">Upload a new image.</a>
        </p>
        <input class="edit_field" type="text" name="first_name" placeholder="First Name">
        <input class="edit_field" type="text" name="last_name" placeholder="Last Name">
        <textarea class="edit_field" name="bio" rows="4" cols="50" placeholder="Tell us about yourself!"></textarea>
    </div>
    <div class="btn_div">
        <button class="edit_toggle">Edit</button>
    </div>
</div>

<h2>{{ dancer.user.first_name }}'s Dances</h2>

<a href="/edit/{{ user.id }}/0/">Add a new dance</a>

<button class="new_pref_btn">Add a new dance</button>

<div id="pref_list">
    <ul class="pref">
        <li class="selected template">
            <div class="read">
                <span class="dance">Dance Style</span>
                <span class="role">Role</span>
                <span class="skill_level">Skill Level</span>
                <span class="activity">Activity Level</span>
                <span class="goal">Goal</span>
                <span class="notes">Notes here.</span>
            </div>
            <div class="edit">
                <select class="edit_field dance_list">Dance Style</select>
                <select class="edit_field role_list">Role</select>
                <select class="edit_field skill_level_list">Skill Level</select>
                <select class="edit_field activity_list">Activity Level</select>
                <select class="edit_field goal_list">Goal</select>
                <textarea class="edit_field notes_textarea" rows="4" cols="50" placeholder="Describe what you're working on.">Notes here.</textarea>
            </div>
            <div>
                <button class="edit_toggle">Edit</button>
            </div>
        </li>
    </ul>
</div>

<!--TODO: Move new pref li into pref list? Fix db posting. Hide and show on btn click.-->
<div id="new_pref">
    <div class="btn_div">
        <button class="save_pref">Save</button>
        <button class="cancel_pref">Cancel</button>
    </div>
</div>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

{% endblock %}