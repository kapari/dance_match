{% extends "base_generic.html" %}
{% load staticfiles %}

{% block content %}


<script>
    var user_id = {{ user.id }}
    var dancer_id = {{ user.dancer.id }}

    document.write("test for user ID " + user_id + "-- dancer ID: " + dancer_id);
    // Draw Loaded Data


    // TODO: get from new app status view
    var models = {};

    function select_options(select, data, name_field, id_field, selected) {
        var not_set = true;
        for (var i = 0; i < data.length; i++) {
            var option = document.createElement('option');
            option.innerHTML = data[i][name_field];
            option.setAttribute("value", data[i][id_field]);
            if (data[i][name_field] == selected) {
                option.setAttribute("selected", "selected");
                not_set = false;
            }
            select.appendChild(option);
        }
        if (not_set) {
            option.innerHTML = "(optional)";
            option.setAttribute("selected", "selected");
        }
    }

    // Draws select options in editable div of li
    function draw_selects(clone, current_pref) {
        var model_lists = ["dance_list", "role_list", "skill_level_list", "activity_list", "goal_list"];
        for (i = 0; i < model_lists.length; i++) {
            current_model = model_lists[i];
            select_options(clone.getElementsByClassName(current_model)[0],
                    window.models[current_model], "name", "id", current_pref.current_model);
        }
    }


    // Draws each pref li in template
    function draw_list(clone, current_pref) {
        var models = ["dancer", "dance", "role", "skill_level", "activity", "goal", "notes"];
        for (i = 0; i < models.length; i++) {
            var current_model = models[i];
            var current_li = clone.getElementsByClassName(current_model)[0];
            current_li.setAttribute("data-model", current_model);
            // For optional fields:
            if (current_pref.current_model) {
                current_li.innerHTML = current_pref.current_model;
            } else {
                current_li.innerHTML = "";
            }
            // For corresponding edit div, not including notes
//            draw_selects(clone, current_pref);
//            var selected_dance = current_pref.dance;
//                select_options(clone.getElementsByClassName("dance_list")[0],
//                        window.models["dance_list"], "name", "id", selected_dance);
        }

    }

    function draw(data, user_id) {
        var pl = document.getElementById("pref_list");
        var template = pl.getElementsByClassName("template")[0];
        console.log(data);

        for (var i = 0; i < data.length; i++) {
            var current_pref = data[i];
            // console.log("dancer: " + current_pref.dancer);
            console.log("current pref:");
            console.log(current_pref);
            if (!user_id || current_pref.user_id == user_id) {
                console.log("user_id " + user_id);
                // console.log("dancer.id " + current_pref.dancer.id);
                // console.log("dancer.user.id " + current_pref.dancer.user.id);
                var clone = template.cloneNode(true);
                clone.classList.remove("template");
                clone.setAttribute("data-id", current_pref.id);
                // draws li with read-only and edit divs, not incl. last textarea
//                draw_list(clone, current_pref);

                clone.getElementsByClassName("dancer")[0].innerHTML = current_pref.user_id;
                clone.getElementsByClassName("dance")[0].innerHTML = current_pref.dance;
                clone.getElementsByClassName("role")[0].innerHTML = current_pref.role;

                if (current_pref.skill_level) {
                    clone.getElementsByClassName("skill_level")[0].innerHTML = current_pref.skill_level;
                } else {
                    clone.getElementsByClassName("skill_level")[0].innerHTML = "";
                }

                if (current_pref.activity) {
                    clone.getElementsByClassName("activity")[0].innerHTML = current_pref.activity;
                } else {
                    clone.getElementsByClassName("activity")[0].innerHTML = "";
                }

                if (current_pref.goal) {
                    clone.getElementsByClassName("goal")[0].innerHTML = current_pref.goal;
                } else {
                    clone.getElementsByClassName("goal")[0].innerHTML = "";
                }
                clone.getElementsByClassName("notes")[0].innerHTML = current_pref.notes;

                var selected_dance = current_pref.dance;
                select_options(clone.getElementsByClassName("dance_list")[0],
                        window.models["dance_list"], "name", "id", selected_dance);

                var selected_role = current_pref.role;
                select_options(clone.getElementsByClassName("role_list")[0],
                        window.models["role_list"], "name", "id", selected_role);

                var selected_skill_level = current_pref.skill_level;
                select_options(clone.getElementsByClassName("skill_level_list")[0],
                            window.models["skill_level_list"], "name", "id", selected_skill_level);

                var selected_activity = current_pref.activity;
                select_options(clone.getElementsByClassName("activity_list")[0],
                            window.models["activity_list"], "name", "id", selected_activity);

                var selected_goal = current_pref.goal;
                select_options(clone.getElementsByClassName("goal_list")[0],
                            window.models["goal_list"], "name", "id", selected_goal);

                clone.getElementsByClassName("notes_textarea")[0].innerHTML = current_pref.notes;

                pl.appendChild(clone);
            }

        }
//        document.body.innerHTML = data
        add_listeners();

    }


    function add_listeners() {

        var edit_fields = document.getElementsByClassName("edit_field");
        for (i = 0; i < edit_fields.length; i++) {
            var current_field = edit_fields[i];
            console.log("current field = " + current_field);
            current_field.addEventListener("change", function (e) {
                var group_div = e.target.parentElement;
                var pref_id_div = group_div.parentElement;
                var pref_id = pref_id_div.getAttribute("data-id");
//                var field_model_id = e.target.getAttribute("data-model_id");
                field_model = "notes";
                var field_value = e.target.value;

//                console.log(e.target.value);
//                console.log(group_div);
//                console.log(pref_id_div.getAttribute("data-id"));

                // TODO: AJAX POST create item
                var update = {"user_id": user_id,
                              "pref_id": pref_id};
                var value = e.target.value;

                // Build:
                if (e.target.classList.contains("dance_list")) {
                    update["dance"] = value;
                } else if (e.target.classList.contains("role_list")){
                    update["role"] = value;
                } else if (e.target.classList.contains("skill_level")){
                    update["skill_level"] = value;
                } else if (e.target.classList.contains("activity")){
                    update["activity"] = value;
                } else if (e.target.classList.contains("goal_list")){
                    update["goal"] = value;
                } else if (e.target.classList.contains("notes_textarea")){
                    update["notes"] = value;
                }

                sendPost(update);
            });
        }
    }

    // AJAX POST
    function sendPost(item) {
        var form_data = new FormData();

        for (var key in item) {
            form_data.append(key, item[key]);
        }

        var request = new XMLHttpRequest();
        request.open("POST", "/update_pref/");
        request.send(form_data);
    }

    function model_api(object_type) {
        // get list of e.g. dances for dropdown
        var url = "/api_" + object_type + "/";
        var request = new XMLHttpRequest();
        request.open("GET", url);
        console.log(request);

        //For pre html5 browsers use onstatuschanged
        request.onloadend = function (e) {
            var json_string = e.currentTarget.responseText;
            var data = JSON.parse(json_string);
            window.models[object_type] = data;
        };

        request.send();
    }

    model_api("dance_list");
    model_api("role_list");
    model_api("skill_level_list");
    model_api("activity_list");
    model_api("goal_list");


    // BEGIN WEB REST API CALL TO GET JSON DATA
    var url = "/api_dance_prefs/";
    var request = new XMLHttpRequest();
    request.open("GET", url);

    //For pre html5 browsers use onstatuschanged
    request.onloadend = function (e) {
        var json_string = e.currentTarget.responseText;
        var data = JSON.parse(json_string);
        draw(data, user_id);
    };

    request.send();


</script>


<h1>{{ dancer.name }}</h1>

<div class="bio">
    {{ dancer.bio }}
</div>
<div class="contact">
    {{ user.email }}
</div>

<br>
<a href="/edit/{{ user.id }}">Edit</a>

<h2>{{ dancer.user.first_name }}'s Dances</h2>

<a href="/edit/{{ user.id }}/0/">Add a new dance</a>

<div id="pref_list">
    <ul class="pref">
        <li class="selected template">
            <div class="read">
                <span class="dance">Dance Style</span>
                <span class="role">Role</span>
                <span class="skill_level">Skill Level</span>
                <span class="activity">Activity Level</span>
                <span class="goal">Goal</span>
                <span class="notes">Notes here.</span>
                <span class="dancer">Dancer name</span>
            </div>
            <div class="edit">
                <select class="edit_field dance_list">Dance Style</select>
                <select class="edit_field role_list">Role</select>
                <select class="edit_field skill_level_list">Skill Level</select>
                <select class="edit_field activity_list">Activity Level</select>
                <select class="edit_field goal_list">Goal</select>
                <textarea class="edit_field notes_textarea">Notes here.</textarea>
            </div>
        </li>
    </ul>
</div>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

{% endblock %}